# .github/workflows/my-custom-tests.yml
name: Run the Parachain Template

on: [push, workflow_dispatch]

jobs:
  # Step 1: Use your reusable setup
  setup:
    name: Setup Development Environment  
    uses: ./.github/workflows/setup-polkadot-dev.yml
    with:
      # Customize as needed
      rust-version: '1.86'
      cache-key-suffix: 'custom-tests'

  # Step 2: Download artifacts and run your custom logic
  custom-tests:
    name: Run Custom Tests
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download built parachain
      uses: actions/download-artifact@v4
      with:
        name: ${{ needs.setup.outputs.artifact-name }}
        path: ./polkadot-artifacts

    - name: Setup minimal Rust (for tools)
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: ${{ needs.setup.outputs.rust-version }}
        default: true

    - name: Restore Polkadot tools
      uses: actions/cache/restore@v4
      with:
        path: |
          ~/.cargo/bin/chain-spec-builder
          ~/.cargo/bin/polkadot-omni-node  
        key: polkadot-tools-10.0.0-0.5.0
        fail-on-cache-miss: true

    - name: Run my custom tests
      run: |
        echo "ðŸš€ Running custom tests with pre-built parachain"
        
        # Make binary executable
        chmod +x ./polkadot-artifacts/parachain-template-node
        
        # Test 1: Check binary works
        ./polkadot-artifacts/parachain-template-node --version
        
        # Test 2: Start node with chain spec
        polkadot-omni-node --chain ./polkadot-artifacts/chain_spec.json --dev --tmp &
        NODE_PID=$!
        
        # Test 3: Wait and verify it's running
        sleep 10
        
        # Test 4: Your custom integration tests here
        echo "âœ… Custom tests passed!"
        
        # Cleanup
        kill $NODE_PID || true